# =============================================================================
# Guacamole Session Broker - Helm Chart Values
# =============================================================================
# This chart deploys the Session Broker AFTER guacamole-helm has been deployed.
# See: https://github.com/MaximeWewer/guacamole-helm
# =============================================================================

# -----------------------------------------------------------------------------
# Guacamole Connection (existing deployment)
# -----------------------------------------------------------------------------
guacamole:
  # URL of the Guacamole service (K8s service name or external URL)
  url: "http://guacamole:8080/guacamole"
  # Admin username
  adminUser: guacadmin
  # Admin password (required if existingSecret not set)
  adminPassword: ""
  # Use an existing secret for the admin password
  existingSecret: ""
  existingSecretKey: "password"

# -----------------------------------------------------------------------------
# Database Connection (PostgreSQL from guacamole-helm or external)
# -----------------------------------------------------------------------------
database:
  # PostgreSQL hostname (K8s service name or external host)
  host: "guacamole-postgresql"
  port: 5432
  # Database name for the broker (can be same as Guacamole)
  name: "guacamole"
  user: "guacamole"
  # Password (required if existingSecret not set)
  password: ""
  # Use an existing secret for the database password
  existingSecret: ""
  existingSecretKey: "password"

# -----------------------------------------------------------------------------
# Vault/OpenBao Integration (for secrets in profiles.yml)
# -----------------------------------------------------------------------------
# Allows using ${vault:key} in autofill credentials
vault:
  enabled: false
  # Vault server address
  address: ""
  # Auth by token (for development)
  token: ""
  # Auth by AppRole (recommended for production)
  roleId: ""
  secretId: ""
  # Existing secret containing Vault credentials
  # Keys: VAULT_TOKEN or VAULT_ROLE_ID + VAULT_SECRET_ID
  existingSecret: ""
  # Vault mount path
  mount: "secret"
  # Path to secrets in Vault
  path: "guacamole/broker"

# -----------------------------------------------------------------------------
# Broker Deployment
# -----------------------------------------------------------------------------
image:
  repository: ghcr.io/maximewewer/guacamole-broker
  tag: latest
  pullPolicy: IfNotPresent

imagePullSecrets: []

replicaCount: 1

resources:
  requests:
    memory: "128Mi"
    cpu: "100m"
  limits:
    memory: "512Mi"
    cpu: "500m"

nodeSelector: {}

tolerations: []

affinity: {}

podAnnotations: {}

podSecurityContext: {}

securityContext: {}

# API key for the broker (required)
apiKey:
  # Plaintext key (required if existingSecret not set)
  value: ""
  # Use an existing secret containing the API key
  existingSecret: ""
  existingSecretKey: "api-key"

# Service configuration
service:
  type: ClusterIP
  port: 5000

# -----------------------------------------------------------------------------
# Container Orchestrator (Kubernetes mode)
# -----------------------------------------------------------------------------
orchestrator:
  # Namespace for VNC pods (defaults to release namespace)
  namespace: ""
  # Labels applied to all VNC pods
  labels:
    app: vnc-session
    managed-by: guacamole-broker
  # Image pull policy for VNC pods: Always, IfNotPresent, Never
  imagePullPolicy: IfNotPresent
  # Image pull secrets for VNC pods
  imagePullSecrets: []
  # Node selector for VNC pod scheduling
  nodeSelector: {}
  # Tolerations for VNC pod scheduling
  tolerations: []
  # Security context for VNC pods
  securityContext:
    runAsNonRoot: false
    runAsUser: 1000

# -----------------------------------------------------------------------------
# VNC Container Configuration
# -----------------------------------------------------------------------------
vnc:
  image:
    repository: ghcr.io/maximewewer/docker-browser-vnc
    tag: 2026.01.2-chromium
  # Connection name displayed in Guacamole
  connectionName: "Virtual Desktop"
  # Timeout in seconds to wait for VNC to be ready
  timeout: 30
  # Resource limits for VNC pods
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "2Gi"
      cpu: "1000m"

# -----------------------------------------------------------------------------
# User Synchronization
# -----------------------------------------------------------------------------
sync:
  # Sync interval in seconds
  interval: 10
  # Users to ignore during sync (system accounts)
  ignoredUsers:
    - guacadmin
  # Force update existing connections on broker restart
  syncConfigOnRestart: true

# -----------------------------------------------------------------------------
# Container Pool (Pre-warming)
# -----------------------------------------------------------------------------
pool:
  # Enable container pre-warming
  enabled: true
  # Containers to start at broker startup
  initContainers: 2
  # Maximum number of containers
  maxContainers: 10
  # Containers to start per sync cycle
  batchSize: 3
  # Resource limits for pool management
  resources:
    # Minimum free RAM required to start a new container (GB)
    minFreeMemoryGb: 2.0
    # Maximum total RAM for all VNC containers (GB), 0 = no limit
    maxTotalMemoryGb: 16.0
    # Maximum percentage of total RAM, 0 = no limit
    maxMemoryPercent: 0.75

# -----------------------------------------------------------------------------
# Container Lifecycle Management
# -----------------------------------------------------------------------------
lifecycle:
  # Keep containers running after user disconnects
  persistAfterDisconnect: true
  # Idle timeout in minutes (after disconnect)
  idleTimeoutMinutes: 3
  # Force kill oldest inactive containers when resources are low
  forceKillOnLowResources: true

# -----------------------------------------------------------------------------
# Guacamole Interface Settings
# -----------------------------------------------------------------------------
guacamoleSettings:
  # Force display of home page instead of auto-connecting
  forceHomePage: true
  # Name of the placeholder home connection
  homeConnectionName: "Home"
  # Session recording configuration
  recording:
    enabled: true
    # Path inside guacd container (use Guacamole variables)
    path: "${HISTORY_PATH}/${HISTORY_UUID}"
    # Recording filename pattern
    name: ""
    # Include keyboard input in recordings
    includeKeys: false
    # Auto-create recording path
    autoCreatePath: true

# -----------------------------------------------------------------------------
# Security & Rate Limiting
# -----------------------------------------------------------------------------
security:
  rateLimiting:
    enabled: true
    # Default limit for read endpoints
    defaultLimit: "200/minute"
    # Stricter limit for write/admin endpoints
    adminLimit: "10/minute"

# -----------------------------------------------------------------------------
# Database Pool
# -----------------------------------------------------------------------------
databasePool:
  # Minimum connections in the pool
  minConnections: 2
  # Maximum connections in the pool
  maxConnections: 8

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
logging:
  # Log level: DEBUG, INFO, WARNING, ERROR
  level: INFO
  # Log format: json or text
  format: json

# -----------------------------------------------------------------------------
# User Profiles
# -----------------------------------------------------------------------------
# Define browser profiles per Guacamole user group.
# Supports variable expansion:
#   ${GUAC_USERNAME} - Guacamole username
#   ${vault:key}     - Secret from Vault (requires vault.enabled: true)
#   ${env:VAR}       - Environment variable from broker
#
# Example with autofill:
#   developers:
#     description: "Development team"
#     priority: 10
#     homepage: "https://github.com"
#     bookmarks:
#       - name: "GitHub"
#         url: "https://github.com"
#     autofill:
#       - url: "https://github.com/login"
#         username: "${GUAC_USERNAME}"
#         password: "${vault:github_password}"
profiles:
  default:
    description: "Default profile for all users"
    priority: 0
    homepage: "https://www.google.com"
    bookmarks:
      - name: "Google"
        url: "https://www.google.com"
      - name: "DuckDuckGo"
        url: "https://duckduckgo.com"

# Use an external ConfigMap for profiles instead of inline
# If set, the profiles section above is ignored
externalProfilesConfigMap: ""

# -----------------------------------------------------------------------------
# RBAC
# -----------------------------------------------------------------------------
serviceAccount:
  # Create a service account for the broker
  create: true
  # Annotations for the service account
  annotations: {}
  # Name override (defaults to release fullname)
  name: ""

rbac:
  # Create Role and RoleBinding for pod management
  create: true
