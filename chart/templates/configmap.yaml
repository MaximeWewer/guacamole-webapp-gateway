apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "guacamole-broker.fullname" . }}-config
  labels:
    {{- include "guacamole-broker.labels" . | nindent 4 }}
data:
  broker.yml: |
    # =============================================================================
    # Session Broker Configuration (Generated by Helm)
    # =============================================================================

    # -----------------------------------------------------------------------------
    # Container Orchestrator
    # -----------------------------------------------------------------------------
    orchestrator:
      backend: kubernetes

      kubernetes:
        namespace: {{ include "guacamole-broker.vncNamespace" . | quote }}
        service_account: {{ include "guacamole-broker.serviceAccountName" . | quote }}
        labels:
          {{- .Values.orchestrator.labels | toYaml | nindent 10 }}
        image_pull_policy: {{ .Values.orchestrator.imagePullPolicy | quote }}
        {{- if .Values.orchestrator.imagePullSecrets }}
        image_pull_secrets:
          {{- .Values.orchestrator.imagePullSecrets | toYaml | nindent 10 }}
        {{- else }}
        image_pull_secrets: []
        {{- end }}
        {{- if .Values.orchestrator.nodeSelector }}
        node_selector:
          {{- .Values.orchestrator.nodeSelector | toYaml | nindent 10 }}
        {{- else }}
        node_selector: {}
        {{- end }}
        {{- if .Values.orchestrator.tolerations }}
        tolerations:
          {{- .Values.orchestrator.tolerations | toYaml | nindent 10 }}
        {{- else }}
        tolerations: []
        {{- end }}
        resources:
          requests:
            memory: {{ .Values.vnc.resources.requests.memory | quote }}
            cpu: {{ .Values.vnc.resources.requests.cpu | quote }}
          limits:
            memory: {{ .Values.vnc.resources.limits.memory | quote }}
            cpu: {{ .Values.vnc.resources.limits.cpu | quote }}
        security_context:
          run_as_non_root: {{ .Values.orchestrator.securityContext.runAsNonRoot }}
          run_as_user: {{ .Values.orchestrator.securityContext.runAsUser }}

    # -----------------------------------------------------------------------------
    # User Synchronization
    # -----------------------------------------------------------------------------
    sync:
      interval: {{ .Values.sync.interval }}
      ignored_users:
        {{- .Values.sync.ignoredUsers | toYaml | nindent 8 }}
      sync_config_on_restart: {{ .Values.sync.syncConfigOnRestart }}

    # -----------------------------------------------------------------------------
    # VNC Containers
    # -----------------------------------------------------------------------------
    containers:
      image: {{ .Values.vnc.image.repository }}:{{ .Values.vnc.image.tag }}
      connection_name: {{ .Values.vnc.connectionName | quote }}
      vnc_timeout: {{ .Values.vnc.timeout }}

    # -----------------------------------------------------------------------------
    # Container Lifecycle Management
    # -----------------------------------------------------------------------------
    lifecycle:
      persist_after_disconnect: {{ .Values.lifecycle.persistAfterDisconnect }}
      idle_timeout_minutes: {{ .Values.lifecycle.idleTimeoutMinutes }}
      force_kill_on_low_resources: {{ .Values.lifecycle.forceKillOnLowResources }}

    # -----------------------------------------------------------------------------
    # Container Pool (Pre-warming)
    # -----------------------------------------------------------------------------
    pool:
      enabled: {{ .Values.pool.enabled }}
      init_containers: {{ .Values.pool.initContainers }}
      max_containers: {{ .Values.pool.maxContainers }}
      batch_size: {{ .Values.pool.batchSize }}
      resources:
        min_free_memory_gb: {{ .Values.pool.resources.minFreeMemoryGb }}
        max_total_memory_gb: {{ .Values.pool.resources.maxTotalMemoryGb }}
        max_memory_percent: {{ .Values.pool.resources.maxMemoryPercent }}

    # -----------------------------------------------------------------------------
    # Guacamole Interface
    # -----------------------------------------------------------------------------
    guacamole:
      force_home_page: {{ .Values.guacamoleSettings.forceHomePage }}
      home_connection_name: {{ .Values.guacamoleSettings.homeConnectionName | quote }}
      recording:
        enabled: {{ .Values.guacamoleSettings.recording.enabled }}
        path: {{ .Values.guacamoleSettings.recording.path | quote }}
        name: {{ .Values.guacamoleSettings.recording.name | quote }}
        include_keys: {{ .Values.guacamoleSettings.recording.includeKeys }}
        auto_create_path: {{ .Values.guacamoleSettings.recording.autoCreatePath }}

    # -----------------------------------------------------------------------------
    # Logging
    # -----------------------------------------------------------------------------
    logging:
      level: {{ .Values.logging.level }}

  {{- if not .Values.externalProfilesConfigMap }}
  profiles.yml: |
    # =============================================================================
    # User Profiles Configuration (Generated by Helm)
    # =============================================================================
    # Define profiles for user groups. Each profile can specify:
    #   - homepage: Browser start page URL
    #   - bookmarks: List of bookmarks (name + url)
    #   - autofill: Auto-fill credentials for specific URLs
    #   - description: Profile description
    #   - priority: Priority level (0 = lowest, higher wins)
    #
    # Variables:
    #   ${GUAC_USERNAME} - Guacamole username of the connected user
    #   ${vault:key}     - Secret from Vault (requires vault.enabled: true)
    #   ${env:VAR}       - Environment variable from the broker container
    # =============================================================================
    {{- .Values.profiles | toYaml | nindent 4 }}
  {{- end }}
